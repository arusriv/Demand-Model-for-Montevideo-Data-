---
title: "2025Feb18 Assignment 1 Brief"
author: "Arushi"
date: "2025-02-18"
output:
  word_document: default
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r}
rm(list=ls())
load("GA_Montevideo_raw.RData")
df<-xx
attributes(df)
summary(df)

#focus on target g2 and a1 - g is generation and a is attraction
names(df)
# g is people in the zone who are going somewhere for a purpose
#a is people incoming to the zone for a purpose 
#select the two targets (only)
df$g2
summary(df$g2)
summary(df[,c(6,14)]) #important to understand how to select range of rows and columns
df$a1
summary(df$a1)

df$g2 <- as.numeric(as.character(df$g2))
df$a1 <- as.numeric(as.character(df$a1))

colSums(is.na(df)) #seems like there are no NA's but the assignment pdf says treat for missing data - check for alternatives- could it be camas?

```
New factors
```{r}
sum(df$sup == 0, na.rm = TRUE)
df$density<-df$pobl/df$sup

```

Univariate outliers
```{r}
#Univariate outliers
summary(df$g2)
boxplot(df$g2)
sumg2<-summary(df$g2)
boxplot(df$g2, main="g2 Boxplot", horizontal= TRUE)
iqr<- as.numeric(sumg2[5]) - as.numeric(sumg2[2]); iqr
mildlow<- as.numeric(sumg2[2]) - 1.5*iqr; mildlow
mildup<- as.numeric(sumg2[5]) + 1.5*iqr; mildup
mildout<-which(df$g2 <mildlow | df$g2>mildup); mildout
length(mildout)
sevlow<- as.numeric(sumg2[2])-3*iqr; sevlow
sevup<- as.numeric(sumg2[5])+3*iqr; sevup
sevout<-which(df$g2<sevlow | df$g2>sevup);sevout
length(sevout)
abline(v=mildlow, col="orange")
abline(v=mildup, col="orange")
abline(v=sevlow, col="red")
abline(v=sevup, col="red")

summary(df$a1)
boxplot(df$a1)
suma1<-summary(df$a1)
boxplot(df$a1, main="a1 Boxplot", horizontal= TRUE)
iqra1<- as.numeric(suma1[5]) - as.numeric(suma1[2]); iqra1
mildlowa1<- as.numeric(suma1[2]) - 1.5*iqra1; mildlowa1
mildupa1<- as.numeric(suma1[5]) + 1.5*iqra1; mildupa1
mildouta1<-which(df$a1 <mildlowa1| df$a1>mildupa1); mildouta1
length(mildouta1)
sevlowa1<- as.numeric(suma1[2])-3*iqra1; sevlowa1
sevupa1<- as.numeric(suma1[5])+3*iqra1; sevupa1
sevouta1<-which(df$a1<sevlowa1 | df$a1>sevupa1);sevouta1
length(sevouta1)
abline(v=mildlowa1, col="orange")
abline(v=mildupa1, col="orange")
abline(v=sevlowa1, col="red")
abline(v=sevupa1, col="red")
```
Multivariate outliers
```{r}
library(chemometrics)
res.mout <- Moutlier(df[, c("g2", "a1", "sup", "pobl", "empleo", "plzesco")], quantile = 0.99)
llmout <- which((res.mout$md > res.mout$cutoff) & (res.mout$rd > res.mout$cutoff));llmout
length(llmout)
par(mfrow=c(1,1))
plot(res.mout$md, res.mout$rd, main= "Multivariable Outliers Detected")
abline(v=res.mout$cutoff, col="red")
abline(h=res.mout$cutoff, col="red")
abline(v=1.5*res.mout$cutoff, col="red")
abline(h=1.5*res.mout$cutoff, col="red")
```
Profiling target variable through condes
```{r}
#profiling for g2 ;g2 is trip generation by purpose of study so people from particular zones going (outgoing) for the purpose of study; 
class(df[c(2:3,20:32,35)][,6])
str(df[c(2:3,20:32,35)])
library(FactoMineR)
res.con <- condes(df[c(2:3,6,20:35)],6)   #if we include f.status2 and 3 
res.con <- condes(df[c(2:3,6,20:32,35)],6) #excluding
#res.con <- condes(df[c(2:3,20:32,35)],6)
res.con$quanti
res.con$quali
#total trips has the strongest correclation but should not be included in predictor because it alr4eady includes g2; density,trips generated by purpose of study and school places are all important; f.status is positively correlated-> high income areas generate more study related trips;centro has high correlation-city centre area has more schools/universities;  similarly, service area and restaurants


```
Building base model
```{r}
library(car)
#BASE MODEL M1 (density+plzesco+pobl)
#first test with all numeric variables 
m1 <- lm(g2 ~ density+sup+plzesco+pobl, data=df)
summary(m1) #statistically significant is when p<0.05
vif(m1) #multicollinearity check vif<5 means no multicollinearity - acceptable
#71.3% - quite strong, R^2 is also high- good fit
marginalModelPlots(m1)   #density-almost linear with slight dispersion at higher values; school places plezco- weak relationship-randomly dispersed; pobl population- strong linear trend-best predictor; sup is also weak; 
par(mfrow=c(2,2))
plot(m1) #checking for a pattern in residuals - plot shows no strong curvature suggesting mostly linear relationship; 

m2<- lm(g2 ~ density+plzesco, data=df)
summary(m2) #bad
#lets see what happens if we replace density with population
m21<- lm(g2~plzesco+pobl, data=df)
summary(m21)  #pobl is stronger than density so lets drop density; plezco is not statistically signihficant 
vif(m21)
marginalModelPlots(m21)     

#Removing plzesco
m3 <- lm(g2 ~ pobl, data=df)
summary(m3)    #R^2 increqased which means pobl is a strong predictor
marginalModelPlots(m3)

m5 <- lm(g2 ~ sup+plzesco+pobl, data=df)
summary(m5)    #R^2 increqased which means pobl is a strong predictor
vif(m5) 

# BASE MODEL Selected-only pobl is statistically significant 
m4<- lm(g2 ~ pobl, data=df)
summary(m4)
par(mfrow=c(2,2))
plot(m4)

#add categorical variables
m4f<- lm(g2 ~ pobl + f.servi+centro+f.restau+f.com+f.ocio+f.status, data=df)
summary(m4f) #increased R^2-pobl remains strong; f.statusbajo is significant meaning low socioeconomic areas have a negative impact on trip generation;other variables are not significant;
vif(m4f)
plot(m4f)
#drop the variables that are statistically insignificant

m4f2<- lm(g2 ~ pobl + f.status, data=df)
summary(m4f2) #increased R^2-pobl remains strong; f.statusbajo is significant meaning low socioeconomic areas have a negative impact on trip generation;other variables are not significant;
vif(m4f)

df$f.statusBajo<- ifelse(df$f.status == "Bajo", "S", "N")
df$f.statusBajo <- as.factor(df$f.statusBajo)
#now we drop f.status since it is statistically insignificant

m4f3<- lm(g2 ~ pobl + f.statusBajo, data=df)
summary(m4f3) #not a big difference on R^2 but our residual standard error reduced and F-statistic increased twice the times so good
vif(m4f3)
plot(m4f3)
AIC(m4f2,m4f3)

```
Transformations
```{r}

m5<- lm(log(g2) ~ log(pobl)+ f.statusBajo,data=df)
summary(m5)
vif(m5)
par(mfrow=c(2,2))
plot(m5)
AIC(m5,m4f3)
BIC(m5,m4f3)
par(mfrow=c(1,1))
influentialg2<- influence.measures(m5)
summary(influentialg2)
influencePlot(m5)
#df$insigpobl<- ifelse(rownames(df) %in% c("1","9","21","38"), 1, 0)
df$insigpobl<- ifelse(rownames(df) %in% c("21","38"), 1, 0)
df$portg2<- ifelse(rownames(df) %in% c("1","9"), 1, 0)

m5d1<- lm(log(g2) ~ log(pobl)+f.statusBajo +insigpobl+portg2, data=df) 
#m5d1<- lm(log(g2) ~ log(pobl)+f.statusBajo +insigpobl, data=df) 
summary(m5d1)
vif(m5d1)
par(mfrow=c(2,2))
plot(m5d1)
cooks.distance(m5d1)    
AIC(m5d1,m5)
anova(m5d1,m5)
par(mfrow=c(1,1))
influentialg2<- influence.measures(m5d1)
summary(influentialg2)
influencePlot(m5d1)

df$insigpobl<- ifelse(rownames(df) %in% c("21","38","46","55"), 1, 0)
#m5d2<- lm(log(g2) ~ log(pobl)+f.statusBajo +insigpobl, data=df)
m5d2<- lm(log(g2) ~ log(pobl)+f.statusBajo +insigpobl+portg2, data=df)
summary(m5d2)
vif(m5d2)
par(mfrow=c(2,2))
plot(m5d2)
cooks.distance(m5d2)    
AIC(m5d2,m5d1)
par(mfrow=c(1,1))
influentialg2<- influence.measures(m5d2)
summary(influentialg2)
influencePlot(m5d2)

#obs21 always stands out and it could have some very unique characteristics
df$insigpobl<- ifelse(rownames(df) %in% c("38","46","55"), 1, 0)
df$obs21 <- ifelse(rownames(df) == "21", 1, 0)
df$portg2<- ifelse(rownames(df) %in% c("1","9"), 1, 0)
m6 <- lm(log(g2) ~ log(pobl) + f.statusBajo + insigpobl +portg2+ obs21, data=df)
summary(m6)
vif(m6)
par(mfrow=c(2,2))
plot(m6)
cooks.distance(m6)    
AIC(m5d2,m6)
anova(m5d2,m6)
par(mfrow=c(1,1))
influentialg2<- influence.measures(m6)
summary(influentialg2)
influencePlot(m6)

library(lmtest)
bptest(m6) #0.4047 >0.05-fail to reject the null hypothesis of homoscedasticity i.e. there no evidence of heteroscedasticity- residuals have constant variance 

m7<- lm(sqrt(g2) ~ sqrt(pobl)+f.statusBajo+insigpobl+portg2+obs21, data=df)
summary(m7)
vif(m7)
par(mfrow=c(2,2))
plot(m7)
AIC(m6,m7)     #this model let to higher R^2 but also increased the AIC BIC by 4 times-super bad

m8<- lm(g2 ~ sqrt(pobl)+f.status +insigpobl+portg2+obs21, data=df)  #BETTER BETTER BETTER
summary(m8)
vif(m8)
par(mfrow=c(2,2))
plot(m8)
AIC(m7,m8)  #m8 has higher AIC!!!!! go back to m7->go back to m6

#Interaction effects
m6i<- lm(log(g2) ~ log(pobl)*f.statusBajo+insigpobl+portg2+obs21, data=df)
summary(m6i)  #our RSE reduced and R^2 kind of remained same
par(mfrow=c(2,2))
plot(m6i) #scale location thereis a sudden increase in variance -not flat
AIC(m6i,m6)  #super reduced AIC
bptest(m6i)

m6i2<-lm(log(g2) ~ log(pobl)*f.statusBajo*insigpobl*portg2*obs21, data=df)
summary(m6i2)  #our RSE reduced and R^2 increased super
par(mfrow=c(2,2))
plot(m6i2)  #showing leverage 21;m6i was better- scale location variance is more announced
AIC(m6i,m6i2)
influentiald <- influence.measures(m6i2)
summary(influentiald)
#comparison between m6i and m6i2- he residuals look more centered than in m6i2; residuals follow the normal line better than m6i2.;The spread of residuals is more uniform than in m6i2, indicating better homoscedasticity;No extreme leverage pointsâ€”much better than m6i2, where 27 and 29 were flagged.Point 21 has slightly higher leverage, but it's still within acceptable limits

shapiro.test(residuals(m6i))  #p>0.05- residuals are normal 
shapiro.test(residuals(m6)) #residuals are normal
```
prediction model (m6)
```{r}
# Generate predictions and confidence intervals
predictionsg2 <- predict(m6, newdata = df, interval = "prediction", level = 0.95)

# Convert predictions back from log scale to original scale
predicted_g2 <- exp(predictionsg2[, "fit"] ) #since in this model g2 was not log transformed 
lower <- exp(predictionsg2[, "lwr"])
upper<- exp(predictionsg2[, "upr"])


# Get actual values and zone IDs
actual_g2 <- df$g2
zone_ids <- df$zt

# Identify points outside CI
outsideci <- actual_g2 < lower | actual_g2> upper
outsidepos <- which(outsideci)

# Calculate EXACT minimum and maximum values
minval <- min(c(lower, actual_g2)) * 0.70  # buffer at bottom
maxval <- max(c(upper, actual_g2)) * 1.0   # buffer at top

# Set up plot area with proper margins
par(mfrow=c(1,1))
par(mar = c(2, 4, 2, 2))

# Calculate positions
xpos <- 1:length(zone_ids)
barwidth <- 0.5
actualpos <- xpos - barwidth/2

# Create base plot with log y-axis starting at exact minimum
plot(xpos, predicted_g2, type = "n", 
     log = "y",
     ylim = c(minval, maxval),  # Now starts exactly at lowest value
     xlab = "", ylab = "Trip Generation for Study (g2) - Log Scale", 
     main = "Actual vs Predicted Study Trip Generations with 95% CI",
     xaxt = "n")


# Add custom x-axis
axis(1, at = xpos, labels = zone_ids, las = 2, cex.axis = 0.7)
mtext("TAZ Zones", side = 1, line = 5)

# Add confidence interval polygon
polygon(c(xpos, rev(xpos)), c(upper, rev(lower)),
        col = adjustcolor("gray", alpha.f = 0.2), border = NA)

# Add actual values as columns - now starting from exact min_val
rect(actualpos, minval, actualpos + barwidth, actual_g2,
     col = adjustcolor("red", alpha.f = 0.2), border = NA)

# Add predicted line and CI bounds
lines(xpos, predicted_g2, col = "blue", lwd = 1)
lines(xpos, upper, col = "black", lty = 2, lwd = 1)
lines(xpos, lower, col = "black", lty = 2, lwd = 1)

# Highlight points outside CI
points(xpos[outsidepos], actual_g2[outsidepos], 
       pch = 8, col = "red", cex = 1.5, lwd = 0.5)
arrows(xpos[outsidepos], actual_g2[outsidepos] * 1.1,
       xpos[outsidepos], actual_g2[outsidepos],
       length = 0.1, col = "red", lwd = 1)

# Add legend
legend("topright", 
       legend = c("Actual g2", "Predicted g2", "95% CI Bounds", "Outside CI"), 
       fill = c(adjustcolor("red", alpha.f = 0.2), NA, NA, NA), 
       lty = c(NA, 1, 2, NA), 
       col = c(NA, "blue", "black", "red"),
       pch = c(NA, NA, NA, 8),
       lwd = c(NA, 2, 1, 2),
       pt.cex = c(NA, NA, NA, 1.5),
       bg = "white")

```
Future Prediction
```{r}
summary(m6)
#population increases by 20% as per assignment pdf
df$pobl_future <- 1.2*df$pobl

df$g2_pred_future <- (predict(m6, newdatag2 = data.frame(
  pobl = log(df$pobl_future),
  f.statusBajo = df$f.statusBajo,
  insigpobl=df$insigpobl,
  portg2=df$portg2,
  obs21=df$obs21
  )))
df$g2_pred_future <- exp(df$g2_pred_future)
#output
df$absolute_changeg2 <-  df$g2_pred_future - df$g2
df$pct_changeg2 <- (df$absolute_changeg2 / df$g2) * 100

comparison <- data.frame(
  Zone = df$zt,
  Original = df$g2,
  Future = df$g2_pred_future,
  Abs_Change = df$absolute_changeg2,
  Pct_Change = df$pct_changeg2
)

head(comparison, 30)


```




